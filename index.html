<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN_OS: CENTRAL_HUB</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Rajdhani:wght@500;700&family=Fira+Code:wght@400;700&display=swap');
        
        :root { 
            --bg: #050508; 
            --red: #ff0055; 
            --blue: #00f2ff; 
            --gold: #ffcc00; 
            --glass: rgba(10, 20, 30, 0.85);
        }

        body { 
            margin: 0; background: var(--bg); color: white; font-family: 'Rajdhani', sans-serif; 
            height: 100vh; overflow: hidden; display: flex; flex-direction: column; 
            background-image: radial-gradient(circle at 50% 50%, #111 0%, #000 100%);
        }

        /* --- LAYOUT --- */
        header {
            display: flex; justify-content: space-between; align-items: center; padding: 20px 40px;
            border-bottom: 2px solid #222; background: rgba(0,0,0,0.9); z-index: 10;
        }

        .logo { font-family: 'Orbitron'; font-size: 2rem; letter-spacing: 5px; text-shadow: 0 0 20px var(--blue); }
        .user-info { font-family: 'Fira Code'; text-align: right; }
        .stat-box { font-size: 0.9rem; color: #888; }
        .highlight { color: var(--gold); }

        .main-interface {
            flex: 1; display: flex; height: 100%; position: relative;
        }

        /* --- LEFT PANEL (MENU) --- */
        .nav-panel {
            width: 300px; border-right: 1px solid #333; padding: 40px;
            display: flex; flex-direction: column; gap: 20px; background: rgba(0,0,0,0.5);
        }

        .nav-btn {
            padding: 20px; border: 1px solid #333; background: transparent; color: white;
            font-family: 'Orbitron'; font-size: 1.2rem; cursor: pointer; text-align: left;
            transition: 0.3s; position: relative; overflow: hidden;
        }
        .nav-btn:hover { background: var(--red); border-color: var(--red); padding-left: 30px; box-shadow: 0 0 30px rgba(255, 0, 85, 0.4); }
        .nav-btn::before { content: ''; position: absolute; top: 0; left: 0; width: 5px; height: 100%; background: var(--blue); }

        /* --- CENTER PANEL (LEADERBOARD) --- */
        .content-panel {
            flex: 1; padding: 40px; overflow-y: auto; position: relative;
        }
        h2 { border-bottom: 2px solid var(--blue); display: inline-block; padding-bottom: 10px; margin-top: 0; }
        
        #lb-content { display: flex; flex-direction: column; gap: 10px; }
        
        /* --- RIGHT PANEL (QUESTS & PRESTIGE) --- */
        .quest-panel {
            width: 350px; border-left: 1px solid #333; padding: 30px;
            background: rgba(0,0,0,0.6); display: flex; flex-direction: column;
        }
        .quest-card {
            background: rgba(0, 242, 255, 0.05); border: 1px solid #333; padding: 15px;
            margin-bottom: 15px; font-family: 'Fira Code'; font-size: 0.8rem;
            position: relative; transition: 0.3s;
        }
        .quest-card.done { border-color: var(--gold); opacity: 0.6; }
        .quest-reward { color: var(--gold); float: right; }

        /* REROLL & CLAIM BUTTONS */
        .action-btn {
            width: 100%; padding: 12px; font-family: 'Orbitron'; font-size: 0.8rem; 
            cursor: pointer; border: 1px solid; margin-top: 10px; transition: 0.3s;
        }
        .reroll-btn { background: transparent; border-color: #444; color: #888; }
        .reroll-btn:hover { border-color: var(--blue); color: var(--blue); }
        .claim-btn { background: var(--gold); color: black; border: none; font-weight: 900; box-shadow: 0 0 15px var(--gold); }

        /* PRESTIGE BUTTON */
        #prestige-box {
            margin-top: auto; padding: 20px; border: 2px solid #333; text-align: center;
            opacity: 0.5; pointer-events: none; transition: 0.5s;
        }
        #prestige-box.ready { opacity: 1; border-color: var(--gold); pointer-events: auto; box-shadow: 0 0 50px rgba(255, 204, 0, 0.2); }
        .prestige-btn {
            width: 100%; background: transparent; color: var(--gold); border: none;
            font-family: 'Orbitron'; font-size: 1.2rem; cursor: pointer; animation: pulse 2s infinite;
        }
        
        @keyframes pulse { 0% { text-shadow: 0 0 10px var(--gold); } 50% { text-shadow: 0 0 30px var(--gold); } 100% { text-shadow: 0 0 10px var(--gold); } }

        /* --- MODALS --- */
        #auth-overlay {
            position: fixed; inset: 0; background: black; z-index: 9999;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        input { background: #111; border: 1px solid #333; color: white; padding: 15px; margin: 10px; width: 300px; font-family: 'Fira Code'; }
        button.auth { background: var(--blue); color: black; border: none; padding: 15px 40px; cursor: pointer; font-weight: bold; font-family: 'Orbitron'; margin-top: 20px; }

    </style>
</head>
<body>

    <div id="auth-overlay">
        <h1 class="logo" style="font-size: 4rem; margin-bottom: 40px;">TITAN_OS</h1>
        <input type="text" id="username" placeholder="PILOT_ID">
        <input type="password" id="password" placeholder="ACCESS_CODE">
        <button class="auth" onclick="handleAuth()">INITIALIZE_LINK</button>
        <div id="auth-msg" style="color: var(--red); margin-top: 20px; font-family: 'Fira Code';"></div>
    </div>

    <header>
        <div class="logo">TITAN_OS <span style="font-size: 0.8rem; color: #444;">v2.5.0</span></div>
        <div class="user-info">
            <div id="user-display" style="font-size: 1.2rem; font-weight: bold; color: var(--blue);">PILOT: UNKNOWN</div>
            <div class="stat-box">LEVEL: <span id="user-lvl" class="highlight">0</span> | PRESTIGE: <span id="user-prestige" style="color: var(--red)">0</span></div>
            <div class="stat-box">CREDITS: <span id="user-credits" class="highlight">0</span>₮</div>
        </div>
    </header>

    <div class="main-interface">
        <div class="nav-panel">
            <button class="nav-btn" onclick="location.href='game.html'">>> ENGAGE_COMBAT</button>
            <button class="nav-btn" onclick="location.href='shop.html'">>> BLACK_MARKET</button>
            <button class="nav-btn" style="border-color: #444; color: #888;">>> SYSTEM_SETTINGS</button>
            <button class="nav-btn" onclick="AccountSystem.logout()" style="margin-top: auto; border-color: var(--red); color: var(--red);">>> TERMINATE_LINK</button>
        </div>

        <div class="content-panel">
            <h2>GLOBAL_RANKINGS</h2>
            <div id="lb-content">
                <div style="padding: 20px; color: #666;">CONNECTING TO SAT-LINK...</div>
            </div>
        </div>

        <div class="quest-panel">
            <h3 style="font-family: 'Orbitron'; color: var(--blue); margin-top: 0;">DAILY_LOGS</h3>
            <div id="quest-list"></div>
            <div id="quest-actions"></div>

            <div id="prestige-box">
                <div style="font-family: 'Fira Code'; font-size: 0.8rem; color: #888; margin-bottom: 10px;">NEURAL RESET REQUIRED LVL 100</div>
                <button class="prestige-btn" onclick="triggerPrestige()">INITIATE_PRESTIGE</button>
            </div>
        </div>
    </div>

    <script src="account.js"></script>
    <script src="leaderboard.js"></script>
    <script>
        // --- QUEST TEMPLATES (Generates 100+ Variations) ---
        const ACTIONS = ["WIN", "EARN", "SECURE", "CONNECT", "OVERLOAD", "DRAIN"];
        const TARGETS = ["DATA_NODES", "MATCHES", "XP_UNITS", "CREDIT_CELLS", "GRID_LINKS"];
        
        function generateUniqueQuests(count = 3) {
            let quests = [];
            for(let i=0; i<count; i++) {
                const act = ACTIONS[Math.floor(Math.random() * ACTIONS.length)];
                const tar = TARGETS[Math.floor(Math.random() * TARGETS.length)];
                const val = (Math.floor(Math.random() * 10) + 1) * 5;
                quests.push({
                    id: 'q_' + Math.random().toString(36).substr(2, 9),
                    desc: `${act} ${val} ${tar}`,
                    target: val,
                    progress: 0,
                    reward: val * 10
                });
            }
            return quests;
        }

        // --- HUB LOGIC ---
        async function handleAuth() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const msg = document.getElementById('auth-msg');
            if(!u || !p) { msg.innerText = "INPUT_MISSING"; return; }
            msg.innerText = "AUTHENTICATING...";
            
            let res = await AccountSystem.login(u, p);
            if (!res.success) res = await AccountSystem.signup(u, p);

            if (res.success) {
                sessionStorage.setItem('titan_user', u);
                sessionStorage.setItem('titan_data', JSON.stringify(res.data || { level: 1, xp: 0, prestige: 0 }));
                document.getElementById('auth-overlay').style.display = 'none';
                initHub();
            } else {
                msg.innerText = "ACCESS_DENIED: " + res.message;
            }
        }

        function initHub() {
            const user = sessionStorage.getItem('titan_user');
            if(!user) return;
            document.getElementById('auth-overlay').style.display = 'none';
            const data = JSON.parse(sessionStorage.getItem('titan_data'));

            document.getElementById('user-display').innerText = `PILOT: ${user.toUpperCase()}`;
            document.getElementById('user-lvl').innerText = data.level || 1;
            document.getElementById('user-prestige').innerText = data.prestige || 0;
            
            fetchCoins(user);
            checkPrestigeStatus(data);
            initDailyQuests(user);
        }

        async function fetchCoins(user) {
            const res = await fetch(`${window.location.origin}/get-coins/${user}`);
            const d = await res.json();
            document.getElementById('user-credits').innerText = d.coins || 0;
            return d.coins || 0;
        }

        // --- QUEST LOGIC ---
        function initDailyQuests(user) {
            const today = new Date().toDateString();
            const storageKey = `titan_quests_${user}`;
            let questData = JSON.parse(localStorage.getItem(storageKey));

            if (!questData || questData.date !== today) {
                questData = { date: today, quests: generateUniqueQuests(), claimed: false };
                localStorage.setItem(storageKey, JSON.stringify(questData));
            }
            renderQuests(questData);
        }

        async function rerollQuests() {
            const user = sessionStorage.getItem('titan_user');
            const currentCredits = await fetchCoins(user);
            
            if (currentCredits < 50) {
                alert("INSUFFICIENT CREDITS: 50₮ REQUIRED");
                return;
            }

            if (!confirm("REROLL LOGS? COST: 50₮")) return;

            // Deduct Credits
            await fetch(`${window.location.origin}/update-coins`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: user, coins: currentCredits - 50 })
            });

            const storageKey = `titan_quests_${user}`;
            const questData = { date: new Date().toDateString(), quests: generateUniqueQuests(), claimed: false };
            localStorage.setItem(storageKey, JSON.stringify(questData));
            initHub();
        }

        function renderQuests(questData) {
            const list = document.getElementById('quest-list');
            const actions = document.getElementById('quest-actions');
            const allDone = questData.quests.every(q => q.progress >= q.target);

            list.innerHTML = questData.quests.map(q => {
                const isDone = q.progress >= q.target;
                return `
                    <div class="quest-card ${isDone ? 'done' : ''}">
                        <span class="quest-reward">${q.reward}₮</span>
                        <div>${q.desc}</div>
                        <div style="height:2px; background:#222; margin-top:10px;">
                            <div style="height:100%; background:var(--blue); width:${(q.progress/q.target)*100}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            let actionHtml = '';
            if (!questData.claimed) {
                if (allDone) {
                    actionHtml = `<button class="action-btn claim-btn" onclick="claimRewards()">CLAIM BUNDLE</button>`;
                } else {
                    actionHtml = `<button class="action-btn reroll-btn" onclick="rerollQuests()">REROLL LOGS (50₮)</button>`;
                }
            } else {
                actionHtml = `<div style="text-align:center; color:var(--gold); font-size:0.8rem; margin-top:10px;">[ALL_LOGS_SECURED]</div>`;
            }
            actions.innerHTML = actionHtml;
        }

        async function claimRewards() {
            const user = sessionStorage.getItem('titan_user');
            const storageKey = `titan_quests_${user}`;
            const questData = JSON.parse(localStorage.getItem(storageKey));
            
            const totalReward = questData.quests.reduce((sum, q) => sum + q.reward, 0);
            const currentCredits = await fetchCoins(user);

            await fetch(`${window.location.origin}/update-coins`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: user, coins: currentCredits + totalReward })
            });

            questData.claimed = true;
            localStorage.setItem(storageKey, JSON.stringify(questData));
            alert(`REWARDS SYNCED: +${totalReward}₮`);
            initHub();
        }

        // --- PRESTIGE SYSTEM ---
        function checkPrestigeStatus(data) {
            const box = document.getElementById('prestige-box');
            if (data.level >= 100) { box.classList.add('ready'); }
        }

        async function triggerPrestige() {
            if(!confirm("SYSTEM RESET: RETURN TO LVL 1 FOR PERMANENT PRESTIGE RANK?")) return;
            const user = sessionStorage.getItem('titan_user');
            let data = JSON.parse(sessionStorage.getItem('titan_data'));
            data.level = 1; data.xp = 0; data.prestige = (data.prestige || 0) + 1;
            sessionStorage.setItem('titan_data', JSON.stringify(data));
            await AccountSystem.saveProgress(user, data);
            location.reload();
        }

        if(sessionStorage.getItem('titan_user')) initHub();
    </script>
</body>
</html>
